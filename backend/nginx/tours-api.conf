# Tours API configuration
# Requires: /etc/nginx/api-keys.map for API key validation

# Tours API endpoints
location /api/tours/ {
    # Include shared proxy configuration (CORS, API key validation)
    include /etc/nginx/snippets/osrm-proxy-common.conf;

    # Rate limiting
    limit_req zone=api_limit burst=20 nodelay;
    limit_req_status 429;

    # Proxy to Tours Server
    proxy_pass http://tours-server:3002/api/tours/;
    proxy_http_version 1.1;
    
    # Timeouts
    proxy_connect_timeout 10s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
    
    # Headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Buffering
    proxy_buffering off;
    proxy_request_buffering off;
}

# Tours health check (no API key required)
location /api/tours/health {
    # CORS headers
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Content-Type' always;

    # No API key validation for health check
    proxy_pass http://tours-server:3002/health;
    proxy_http_version 1.1;
}
