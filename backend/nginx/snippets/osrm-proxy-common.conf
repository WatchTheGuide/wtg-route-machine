# Common proxy configuration for OSRM endpoints
# Include this in each location block: include /etc/nginx/snippets/osrm-proxy-common.conf;

# CORS Headers
add_header Access-Control-Allow-Origin "*" always;
add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
add_header Access-Control-Allow-Headers "X-API-Key, Content-Type" always;

# Handle OPTIONS preflight
if ($request_method = 'OPTIONS') {
    return 204;
}

# API Key validation
if ($api_client_name = "unauthorized") {
    return 401 '{"error": "Unauthorized - Invalid or missing API key"}';
}

# Hide OSRM's CORS headers (we set our own above)
proxy_hide_header Access-Control-Allow-Origin;
proxy_hide_header Access-Control-Allow-Methods;
proxy_hide_header Access-Control-Allow-Headers;

# Standard proxy headers
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;
proxy_set_header X-Client-Name $api_client_name;

# Timeouts
proxy_connect_timeout 5s;
proxy_send_timeout 10s;
proxy_read_timeout 10s;
