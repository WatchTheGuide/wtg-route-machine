# WTG Route Machine - Multi-City Nginx Configuration
# Secure API Gateway with SSL and API Key Authentication
#
# Obsługuje 4 miasta × 3 profile = 12 endpointów
# URL format: /api/{city}/{profile}/route/v1/{profile}/{coordinates}
#
# Miasta: krakow, warszawa, wroclaw, trojmiasto
# Profile: foot, bicycle, car

# Rate limiting zone (10 requests per second per IP)
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

# API Key validation map
map $http_x_api_key $api_client_name {
    default "unauthorized";
    
    # API keys loaded from external file
    include /etc/nginx/api-keys.map;
}

# ============================================
# KRAKÓW - Upstream servers
# ============================================
upstream osrm_krakow_foot {
    server localhost:5001;
}

upstream osrm_krakow_bicycle {
    server localhost:5002;
}

upstream osrm_krakow_car {
    server localhost:5003;
}

# ============================================
# WARSZAWA - Upstream servers
# ============================================
upstream osrm_warszawa_foot {
    server localhost:5011;
}

upstream osrm_warszawa_bicycle {
    server localhost:5012;
}

upstream osrm_warszawa_car {
    server localhost:5013;
}

# ============================================
# WROCŁAW - Upstream servers
# ============================================
upstream osrm_wroclaw_foot {
    server localhost:5021;
}

upstream osrm_wroclaw_bicycle {
    server localhost:5022;
}

upstream osrm_wroclaw_car {
    server localhost:5023;
}

# ============================================
# TRÓJMIASTO - Upstream servers
# ============================================
upstream osrm_trojmiasto_foot {
    server localhost:5031;
}

upstream osrm_trojmiasto_bicycle {
    server localhost:5032;
}

upstream osrm_trojmiasto_car {
    server localhost:5033;
}

# Legacy upstreams (for backward compatibility with old API)
upstream osrm_foot {
    server localhost:5001;
}

upstream osrm_bicycle {
    server localhost:5002;
}

upstream osrm_car {
    server localhost:5003;
}

# HTTP → HTTPS redirect
server {
    listen 80;
    listen [::]:80;
    server_name osrm.watchtheguide.com;

    # Allow Let's Encrypt verification
    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }

    # Redirect all other traffic to HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS Server
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name osrm.watchtheguide.com;

    # SSL Certificate (Let's Encrypt)
    ssl_certificate /etc/letsencrypt/live/osrm.watchtheguide.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/osrm.watchtheguide.com/privkey.pem;

    # SSL Configuration (Modern, Secure)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # Security Headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Rate limiting
    limit_req zone=api_limit burst=20 nodelay;

    # Health check endpoint (no API key required)
    location = /health {
        access_log off;
        return 200 '{"status":"ok","service":"wtg-route-machine","version":"2.0"}';
        add_header Content-Type application/json;
    }

    # City-specific health checks
    location ~ ^/health/(?<city>krakow|warszawa|wroclaw|trojmiasto)$ {
        access_log off;
        # TODO: Implement actual health check to containers
        return 200 '{"status":"ok","city":"$city"}';
        add_header Content-Type application/json;
    }

    # Default location - API documentation (no API key required)
    location = / {
        return 200 '{
            "service": "WTG Route Machine API",
            "version": "2.0",
            "cities": ["krakow", "warszawa", "wroclaw", "trojmiasto"],
            "profiles": ["foot", "bicycle", "car"],
            "endpoints": {
                "multi-city": "https://osrm.watchtheguide.com/api/{city}/{profile}/route/v1/{profile}/{coordinates}",
                "legacy": "https://osrm.watchtheguide.com/api/{profile}/route/v1/{profile}/{coordinates}"
            },
            "examples": {
                "krakow_foot": "https://osrm.watchtheguide.com/api/krakow/foot/route/v1/foot/19.9385,50.0647;19.94,50.065",
                "warszawa_bicycle": "https://osrm.watchtheguide.com/api/warszawa/bicycle/route/v1/bicycle/21.0122,52.2297;21.02,52.23"
            },
            "authentication": "Required - Send X-API-Key header",
            "docs": "https://github.com/WatchTheGuide/wtg-route-machine"
        }';
        add_header Content-Type application/json;
    }

    # ============================================
    # KRAKÓW - API Endpoints
    # ============================================
    location /api/krakow/foot/ {
        include /etc/nginx/snippets/osrm-proxy-common.conf;
        rewrite ^/api/krakow/foot/(.*)$ /$1 break;
        proxy_pass http://osrm_krakow_foot;
    }

    location /api/krakow/bicycle/ {
        include /etc/nginx/snippets/osrm-proxy-common.conf;
        rewrite ^/api/krakow/bicycle/(.*)$ /$1 break;
        proxy_pass http://osrm_krakow_bicycle;
    }

    location /api/krakow/car/ {
        include /etc/nginx/snippets/osrm-proxy-common.conf;
        rewrite ^/api/krakow/car/(.*)$ /$1 break;
        proxy_pass http://osrm_krakow_car;
    }

    # ============================================
    # WARSZAWA - API Endpoints
    # ============================================
    location /api/warszawa/foot/ {
        include /etc/nginx/snippets/osrm-proxy-common.conf;
        rewrite ^/api/warszawa/foot/(.*)$ /$1 break;
        proxy_pass http://osrm_warszawa_foot;
    }

    location /api/warszawa/bicycle/ {
        include /etc/nginx/snippets/osrm-proxy-common.conf;
        rewrite ^/api/warszawa/bicycle/(.*)$ /$1 break;
        proxy_pass http://osrm_warszawa_bicycle;
    }

    location /api/warszawa/car/ {
        include /etc/nginx/snippets/osrm-proxy-common.conf;
        rewrite ^/api/warszawa/car/(.*)$ /$1 break;
        proxy_pass http://osrm_warszawa_car;
    }

    # ============================================
    # WROCŁAW - API Endpoints
    # ============================================
    location /api/wroclaw/foot/ {
        include /etc/nginx/snippets/osrm-proxy-common.conf;
        rewrite ^/api/wroclaw/foot/(.*)$ /$1 break;
        proxy_pass http://osrm_wroclaw_foot;
    }

    location /api/wroclaw/bicycle/ {
        include /etc/nginx/snippets/osrm-proxy-common.conf;
        rewrite ^/api/wroclaw/bicycle/(.*)$ /$1 break;
        proxy_pass http://osrm_wroclaw_bicycle;
    }

    location /api/wroclaw/car/ {
        include /etc/nginx/snippets/osrm-proxy-common.conf;
        rewrite ^/api/wroclaw/car/(.*)$ /$1 break;
        proxy_pass http://osrm_wroclaw_car;
    }

    # ============================================
    # TRÓJMIASTO - API Endpoints
    # ============================================
    location /api/trojmiasto/foot/ {
        include /etc/nginx/snippets/osrm-proxy-common.conf;
        rewrite ^/api/trojmiasto/foot/(.*)$ /$1 break;
        proxy_pass http://osrm_trojmiasto_foot;
    }

    location /api/trojmiasto/bicycle/ {
        include /etc/nginx/snippets/osrm-proxy-common.conf;
        rewrite ^/api/trojmiasto/bicycle/(.*)$ /$1 break;
        proxy_pass http://osrm_trojmiasto_bicycle;
    }

    location /api/trojmiasto/car/ {
        include /etc/nginx/snippets/osrm-proxy-common.conf;
        rewrite ^/api/trojmiasto/car/(.*)$ /$1 break;
        proxy_pass http://osrm_trojmiasto_car;
    }

    # ============================================
    # LEGACY ENDPOINTS (backward compatibility)
    # Maps to Kraków as default city
    # ============================================
    location /api/foot/ {
        include /etc/nginx/snippets/osrm-proxy-common.conf;
        rewrite ^/api/foot/(.*)$ /$1 break;
        proxy_pass http://osrm_foot;
    }

    location /api/bicycle/ {
        include /etc/nginx/snippets/osrm-proxy-common.conf;
        rewrite ^/api/bicycle/(.*)$ /$1 break;
        proxy_pass http://osrm_bicycle;
    }

    location /api/car/ {
        include /etc/nginx/snippets/osrm-proxy-common.conf;
        rewrite ^/api/car/(.*)$ /$1 break;
        proxy_pass http://osrm_car;
    }
}
