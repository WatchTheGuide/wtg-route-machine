# WTG Route Machine - Multi-City Docker Compose
# Obsługuje 4 miasta × 3 profile = 12 kontenerów OSRM
#
# Miasta: Kraków, Warszawa, Wrocław, Trójmiasto
# Profile: foot (pieszy), bicycle (rowerowy), car (samochodowy)
#
# Użycie:
#   docker-compose -f docker-compose.multi-city.yml up -d
#   docker-compose -f docker-compose.multi-city.yml down
#   docker-compose -f docker-compose.multi-city.yml logs -f

x-osrm-defaults: &osrm-defaults
  image: ghcr.io/project-osrm/osrm-backend:latest
  restart: unless-stopped
  networks:
    - osrm-network
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 10s
  deploy:
    resources:
      limits:
        memory: 512M
      reservations:
        memory: 256M

services:
  # ============================================
  # KRAKÓW
  # ============================================
  osrm-krakow-foot:
    <<: *osrm-defaults
    container_name: osrm-krakow-foot
    ports:
      - "5001:5000"
    volumes:
      - ./osrm-data:/data:ro
    command: osrm-routed --algorithm mld /data/krakow-foot.osrm --max-table-size 10000

  osrm-krakow-bicycle:
    <<: *osrm-defaults
    container_name: osrm-krakow-bicycle
    ports:
      - "5002:5000"
    volumes:
      - ./osrm-data:/data:ro
    command: osrm-routed --algorithm mld /data/krakow-bicycle.osrm --max-table-size 10000

  osrm-krakow-car:
    <<: *osrm-defaults
    container_name: osrm-krakow-car
    ports:
      - "5003:5000"
    volumes:
      - ./osrm-data:/data:ro
    command: osrm-routed --algorithm mld /data/krakow-car.osrm --max-table-size 10000

  # ============================================
  # WARSZAWA
  # ============================================
  osrm-warszawa-foot:
    <<: *osrm-defaults
    container_name: osrm-warszawa-foot
    ports:
      - "5011:5000"
    volumes:
      - ./osrm-data:/data:ro
    command: osrm-routed --algorithm mld /data/warszawa-foot.osrm --max-table-size 10000

  osrm-warszawa-bicycle:
    <<: *osrm-defaults
    container_name: osrm-warszawa-bicycle
    ports:
      - "5012:5000"
    volumes:
      - ./osrm-data:/data:ro
    command: osrm-routed --algorithm mld /data/warszawa-bicycle.osrm --max-table-size 10000

  osrm-warszawa-car:
    <<: *osrm-defaults
    container_name: osrm-warszawa-car
    ports:
      - "5013:5000"
    volumes:
      - ./osrm-data:/data:ro
    command: osrm-routed --algorithm mld /data/warszawa-car.osrm --max-table-size 10000

  # ============================================
  # WROCŁAW
  # ============================================
  osrm-wroclaw-foot:
    <<: *osrm-defaults
    container_name: osrm-wroclaw-foot
    ports:
      - "5021:5000"
    volumes:
      - ./osrm-data:/data:ro
    command: osrm-routed --algorithm mld /data/wroclaw-foot.osrm --max-table-size 10000

  osrm-wroclaw-bicycle:
    <<: *osrm-defaults
    container_name: osrm-wroclaw-bicycle
    ports:
      - "5022:5000"
    volumes:
      - ./osrm-data:/data:ro
    command: osrm-routed --algorithm mld /data/wroclaw-bicycle.osrm --max-table-size 10000

  osrm-wroclaw-car:
    <<: *osrm-defaults
    container_name: osrm-wroclaw-car
    ports:
      - "5023:5000"
    volumes:
      - ./osrm-data:/data:ro
    command: osrm-routed --algorithm mld /data/wroclaw-car.osrm --max-table-size 10000

  # ============================================
  # TRÓJMIASTO (Gdańsk, Sopot, Gdynia)
  # ============================================
  osrm-trojmiasto-foot:
    <<: *osrm-defaults
    container_name: osrm-trojmiasto-foot
    ports:
      - "5031:5000"
    volumes:
      - ./osrm-data:/data:ro
    command: osrm-routed --algorithm mld /data/trojmiasto-foot.osrm --max-table-size 10000

  osrm-trojmiasto-bicycle:
    <<: *osrm-defaults
    container_name: osrm-trojmiasto-bicycle
    ports:
      - "5032:5000"
    volumes:
      - ./osrm-data:/data:ro
    command: osrm-routed --algorithm mld /data/trojmiasto-bicycle.osrm --max-table-size 10000

  osrm-trojmiasto-car:
    <<: *osrm-defaults
    container_name: osrm-trojmiasto-car
    ports:
      - "5033:5000"
    volumes:
      - ./osrm-data:/data:ro
    command: osrm-routed --algorithm mld /data/trojmiasto-car.osrm --max-table-size 10000

  # ============================================
  # POI SERVER - Points of Interest API
  # ============================================
  poi-server:
    build:
      context: ./poi-server
      dockerfile: Dockerfile
    container_name: wtg-poi-server
    restart: unless-stopped
    ports:
      - "4000:4000"
    environment:
      - NODE_ENV=production
      - PORT=4000
    networks:
      - osrm-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M

networks:
  osrm-network:
    driver: bridge
    name: wtg-osrm-network
